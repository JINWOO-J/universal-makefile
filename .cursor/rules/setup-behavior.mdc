---
alwaysApply: true
description: setup.sh mode dispatcher (bootstrap/submodule/subtree/auto), hard guard scope, and debug
globs: setup.sh
---
# setup.sh — Source Mode Dispatcher and Defaults

- 기본 동작: `UMS_SOURCE_MODE` 기본값은 `bootstrap`.
- CLI 플래그: `--mode|--source <bootstrap|submodule|subtree|auto>` 지원. 환경변수 `UMS_SOURCE_MODE`도 동일하게 지원.
- 디버그: `--debug|-d` 시 `[debug] source: SOURCE_MODE=...` 출력.

## Mode Dispatcher

- bootstrap:
  - 항상 릴리스 부트스트랩 경로 실행.
  - `.ums-version` 또는 최신 태그로 `DESIRED_VERSION` 결정. `--version`이 있으면 우선. `--force`로 최신 강제 가능.
  - 토큰 인지 API tarball URL을 우선 사용하고, 필요 시 공개 codeload로 폴백.
  - `.ums-release-version` 기록, `UPDATE_PIN`에 따라 `.ums-version` 동기화.

- submodule:
  - `.gitmodules`에 `path = ${MAKEFILE_SYSTEM_DIR}`(기본 `universal-makefile`) 확인.
  - 미초기화 시 `git submodule update --init --recursive` 실행.
  - 성공 시 `./install.sh install` 안내 후 종료. 없으면 `bootstrap`으로 폴백.

- subtree:
  - git 리포에서만 동작. `git log --grep="git-subtree-dir: ${MAKEFILE_SYSTEM_DIR}" --oneline 2>/dev/null`로 감지.
  - 감지 실패 시 `bootstrap`으로 폴백.

- auto:
  - git 리포인 경우 `submodule` → `subtree` 순으로 감지 후 처리.
  - 둘 다 없으면 `bootstrap`으로 폴백.

## Hard Guard Scope

- UMS 시스템 디렉토리 내부에서 실행할 때만 차단:
  - 조건: `[[ -f "makefiles/core.mk" ]] && [[ $(basename $PWD) == ${GITHUB_REPO} ]]`
  - 메시지: “Detected UMF system directory (...). Use install.sh for maintenance.”
- 단지 git 리포라는 이유만으로는 차단하지 않음. (로컬 리포에서 사용 가능)
- 필요 시 `--allow-local` 또는 `UMS_SETUP_ALLOW_LOCAL=true`로 우회.

## Version Selection & Policy (Unified)

- 우선순위: `--version <ref>` > `-f/--force` > `UMS_BOOTSTRAP_POLICY`(latest|prompt|pin) > `.ums-version`(핀) > 현재 설치본
- 기본 정책: `UMS_BOOTSTRAP_POLICY=prompt`
  - TTY에서 최신 존재 시 한 번 질의(기본은 Pinned)
  - 비대화형/CI에서는 조용히 정책/핀에 따름
- 최신/동의/강제로 버전이 바뀌면 `.ums-version` 동기화(`UPDATE_PIN=true`).

## Version Files

- 설치된 UMF 버전: `$(MAKEFILE_SYSTEM_DIR)/.version`
- 핀(희망) 버전: `.ums-version` (프로젝트 루트)
- 마지막 부트스트랩/설치 릴리스: `.ums-release-version` (프로젝트 루트)

## 참고

- `MAKEFILE_SYSTEM_DIR` 기본값은 `${GITHUB_REPO}`.
- 위치 인자: `./setup.sh v1.2.3`, `./setup.sh main` 등 지원.
- 디버그 예시: `[debug] flags ...`, `[debug] source: SOURCE_MODE=...`

참조 파일
- [setup.sh](mdc:setup.sh)

