# ë°°í¬ í›… ì„¤ì • íŒŒì¼
# í”„ë¡œì íŠ¸ë³„ë¡œ ì»¤ìŠ¤í„°ë§ˆì´ì§• ê°€ëŠ¥

# Pre-deploy í›… ì„¤ì •
pre_deploy:
  # í™˜ê²½ ë³€ìˆ˜ ê²€ì¦
  - name: "environment_check"
    type: "builtin"
    enabled: true
    config:
      required_vars:
        - "ENVIRONMENT"
        - "SERVICE_KIND"
        - "DOCKER_REGISTRY"
      service_specific:
        fe:
          - "NODE_ENV"
          - "API_URL"
        be:
          - "DRIVE_DEFAULT_COMPANY"
          - "DATABASE_URL"

  # Docker í™˜ê²½ ê²€ì‚¬
  - name: "docker_check"
    type: "builtin"
    enabled: true
    config:
      timeout: 10

  # ë””ìŠ¤í¬ ê³µê°„ ê²€ì‚¬
  - name: "disk_space_check"
    type: "builtin"
    enabled: true
    config:
      min_free_gb: 5.0

  # ë„¤íŠ¸ì›Œí¬ ì—°ê²° ê²€ì‚¬
  - name: "network_check"
    type: "builtin"
    enabled: true
    config:
      test_urls:
        - "https://httpbin.org/status/200"
      timeout: 10

  # ì»¤ìŠ¤í…€ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
  - name: "custom_pre_check"
    type: "script"
    enabled: false
    config:
      script_path: "./scripts/custom_pre_deploy.sh"
      timeout: 60
      args: ["${ENVIRONMENT}", "${SERVICE_KIND}"]

  # ì™¸ë¶€ URL í˜¸ì¶œ
  - name: "webhook_pre_deploy"
    type: "webhook"
    enabled: false
    config:
      url: "https://api.example.com/pre-deploy"
      method: "POST"
      headers:
        Authorization: "Bearer ${DEPLOY_TOKEN}"
      payload:
        environment: "${ENVIRONMENT}"
        service: "${SERVICE_KIND}"
        version: "${VERSION}"

# Post-deploy í›… ì„¤ì •
post_deploy:
  # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
  - name: "container_status_check"
    type: "builtin"
    enabled: true
    config:
      timeout: 30

  # ì„œë¹„ìŠ¤ ì‘ë‹µ í™•ì¸
  - name: "service_response_check"
    type: "builtin"
    enabled: true
    config:
      health_urls:
        fe:
          - "http://localhost:3000/health"
        be:
          - "http://localhost:8000/health"
          - "http://localhost:8000/api/status"
      timeout: 30
      retries: 3

  # ë°ì´í„°ë² ì´ìŠ¤ í—¬ìŠ¤ í™•ì¸
  - name: "database_health_check"
    type: "builtin"
    enabled: true
    condition: "service_kind == 'be'"
    config:
      timeout: 10

  # ë¡œê·¸ ì—ëŸ¬ í™•ì¸
  - name: "log_error_check"
    type: "builtin"
    enabled: true
    config:
      error_patterns:
        - "fatal error"
        - "panic:"
        - "segmentation fault"
        - "out of memory"
      log_lines: 100

  # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  - name: "performance_test"
    type: "script"
    enabled: false
    config:
      script_path: "./scripts/performance_test.sh"
      timeout: 300
      args: ["${ENVIRONMENT}"]

  # Slack ì•Œë¦¼
  - name: "slack_notification"
    type: "webhook"
    enabled: true
    config:
      url: "${SLACK_WEBHOOK_URL}"
      method: "POST"
      payload:
        text: "ğŸš€ ë°°í¬ ì™„ë£Œ: ${SERVICE_KIND} (${ENVIRONMENT}) - ${VERSION}"
        channel: "#deployments"

  # ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ë“±ë¡
  - name: "monitoring_registration"
    type: "webhook"
    enabled: false
    config:
      url: "https://monitoring.example.com/register"
      method: "POST"
      headers:
        Authorization: "Bearer ${MONITORING_TOKEN}"
      payload:
        service: "${SERVICE_KIND}"
        environment: "${ENVIRONMENT}"
        version: "${VERSION}"
        health_url: "http://localhost:${PORT}/health"

# ì „ì—­ ì„¤ì •
global:
  # ì‹¤íŒ¨ ì‹œ ë™ì‘
  on_failure:
    stop_on_first_failure: true
    send_notification: true
    auto_rollback: false

  # ì¬ì‹œë„ ì„¤ì •
  retry:
    max_attempts: 3
    delay_seconds: 30

  # íƒ€ì„ì•„ì›ƒ ì„¤ì •
  timeout:
    default: 60
    max: 300

  # í™˜ê²½ë³„ ì„¤ì • ì˜¤ë²„ë¼ì´ë“œ
  environment_overrides:
    production:
      retry:
        max_attempts: 5
      on_failure:
        auto_rollback: true
    
    development:
      on_failure:
        stop_on_first_failure: false